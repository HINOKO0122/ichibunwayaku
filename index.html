<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>論文リーダー</title>
    <style>
        /* 全体のレイアウト調整 */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 15px; 
            padding-bottom: 140px; /* ボタンに被らないよう余白を広げる */
            line-height: 1.8; 
            background-color: #f8f9fa;
            color: #2c3e50;
        }

        /* 入力エリアを使いやすく */
        textarea { 
            width: 100%; 
            font-size: 16px; /* スマホでズームされないための最小サイズ */
            padding: 12px; 
            border: 2px solid #ced4da; 
            border-radius: 12px; 
            box-sizing: border-box; 
            margin-bottom: 15px;
        }

        /* 実行ボタンを大きく */
        #exec-btn { 
            width: 100%; 
            padding: 18px; 
            font-size: 1.1rem; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* 分割されたテキストの表示 */
        #output div { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 1.1rem; /* 文字を大きく */
        }

        /* 翻訳の表示切り替え */
        .translation { display: none; color: #d9534f; font-weight: bold; }
        body.show-translation .original { display: none; }
        body.show-translation .translation { display: block; }

        /* 【重要】下部固定ボタンの大型化 */
        .footer-btn {
            position: fixed; 
            bottom: 30px; 
            left: 5%;
            width: 90%; /* 画面幅いっぱいに近く */
            padding: 25px; 
            font-size: 1.4rem; /* かなり大きく */
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 50px; 
            font-weight: bold;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            
            /* スマホ用設定：長押しメニュー防止と連打対応 */
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; 
        }
        .footer-btn:active { background: #0056b3; transform: scale(0.98); }
    </style>
</head>
<body>

    <textarea id="input" rows="6" placeholder="英文をここにペースト"></textarea>
    <button id="exec-btn" onclick="processText()">英文を分割・翻訳する</button>

    <div id="output"></div>

    <div id="translateBtn" class="footer-btn">和訳を表示（長押し）</div>

    <script>
        async function processText() {
    const input = document.getElementById('input').value;
    const output = document.getElementById('output');
    const gasUrl = "https://script.google.com/macros/s/AKfycbxiBtK8TIpoUxGAqzdoYmawb4PIFo81D7O9hU05J5ZKpL4_h-t8P3DlWWkOSZnjm4Fq/exec"; 

    // キャッシュ確認（節約用）
    const cacheKey = btoa(encodeURIComponent(input)).substring(0, 30);
    const cache = localStorage.getItem(cacheKey);
    if (cache) {
        output.innerHTML = cache;
        return;
    }

    output.innerHTML = '翻訳中...（文ごとに分割しています）';

    try {
        const response = await fetch(`${gasUrl}?text=${encodeURIComponent(input)}`);
        const resultText = await response.text();

        // GAS側と同じルールで原文を分割
        const originalLines = input.split(/(?<=[.!?])\s+/);
        // GAS側から「|||」区切りで返ってきた和訳を分割
        const translatedLines = resultText.split('|||');

        let htmlContent = '';
        originalLines.forEach((line, i) => {
            if (line.trim() === "") return;
            htmlContent += `
                <div>
                    <span class="original">${line}</span>
                    <span class="translation">${translatedLines[i] || '（訳がありません）'}</span>
                </div>
            `;
        });

        output.innerHTML = htmlContent;
        localStorage.setItem(cacheKey, htmlContent);

    } catch (e) {
        output.innerHTML = 'エラーが発生しました。通信環境やGASの設定を確認してください。';
        console.error(e);
    }
}
        // スマホで快適に動くためのイベント制御
        const btn = document.getElementById('translateBtn');
        const toggleOn = (e) => {
            e.preventDefault();
            document.body.classList.add('show-translation');
        };
        const toggleOff = (e) => {
            e.preventDefault();
            document.body.classList.remove('show-translation');
        };

        // タッチイベント（スマホ用）
        btn.addEventListener('touchstart', toggleOn, {passive: false});
        btn.addEventListener('touchend', toggleOff, {passive: false});
        
        // マウスイベント（PC確認用）
        btn.addEventListener('mousedown', toggleOn);
        btn.addEventListener('mouseup', toggleOff);
    </script>
</body>
</html>
