<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Line-by-Line Translator</title>
    <style>
        body { font-family: sans-serif; padding-bottom: 100px; }
        #output div { margin-bottom: 10px; padding: 5px; border-bottom: 1px dotted #ccc; }
        
        /* ボタンを押している間の表示切り替え */
        .translation { display: none; color: blue; }
        body.show-translation .original { display: none; }
        body.show-translation .translation { display: block; }

        /* 下部固定ボタン */
        .footer-btn {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px; font-size: 1.2rem;
            background: #007bff; color: white; border: none;
            border-radius: 50px; cursor: pointer; user-select: none;
        }
    </style>
</head>
<body>

    <textarea id="input" rows="10" style="width:100%" placeholder="英文を貼り付けてください"></textarea>
    <button onclick="processText()">分割して表示</button>

    <div id="output"></div>

    <button id="translateBtn" class="footer-btn">押している間だけ和訳</button>

    <script>
       async function processText() {
    const input = document.getElementById('input').value;
    const output = document.getElementById('output');
    const gasUrl = "https://script.google.com/macros/s/AKfycbyKXurqqHdkdB8wNz9wpgnqgEZrrB95UJui1Jh81_lIbCHjCuiaXol09qVs8k-JorG_/exec"; 

    // キャッシュ確認（節約用）
    const cacheKey = btoa(encodeURIComponent(input)).substring(0, 30);
    const cache = localStorage.getItem(cacheKey);
    if (cache) {
        output.innerHTML = cache;
        return;
    }

    output.innerHTML = '翻訳中...（文ごとに分割しています）';

    try {
        const response = await fetch(`${gasUrl}?text=${encodeURIComponent(input)}`);
        const resultText = await response.text();

        // GAS側と同じルールで原文を分割
        const originalLines = input.split(/(?<=[.!?])\s+/);
        // GAS側から「|||」区切りで返ってきた和訳を分割
        const translatedLines = resultText.split('|||');

        let htmlContent = '';
        originalLines.forEach((line, i) => {
            if (line.trim() === "") return;
            htmlContent += `
                <div>
                    <span class="original">${line}</span>
                    <span class="translation">${translatedLines[i] || '（訳がありません）'}</span>
                </div>
            `;
        });

        output.innerHTML = htmlContent;
        localStorage.setItem(cacheKey, htmlContent);

    } catch (e) {
        output.innerHTML = 'エラーが発生しました。通信環境やGASの設定を確認してください。';
        console.error(e);
    }
}

        const btn = document.getElementById('translateBtn');
        // マウス/タッチ操作でクラスを切り替え
        const toggleOn = () => document.body.classList.add('show-translation');
        const toggleOff = () => document.body.classList.remove('show-translation');

        btn.addEventListener('mousedown', toggleOn);
        btn.addEventListener('mouseup', toggleOff);
        btn.addEventListener('touchstart', toggleOn);
        btn.addEventListener('touchend', toggleOff);
    </script>
</body>
</html>
